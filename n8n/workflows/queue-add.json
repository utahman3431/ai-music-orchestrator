{
  "name": "Queue - Add Job",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "queue/add",
        "options": {
          "responseData": "={{$json}}"
        }
      },
      "name": "Webhook - Add",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -200,
        300
      ],
      "webhookId": "queue-add"
    },
    {
      "parameters": {
        "code": "const fs = require('fs');\nconst fsp = fs.promises;\nconst path = require('path');\n\ntry {\n  const body = items[0].json;\n  const root = '/data/orchestration';\n  const queuePath = path.join(root, 'queue.json');\n  const statePath = path.join(root, 'state.json');\n  const jobId = body.id || `job-${Date.now()}-${Math.random().toString(16).slice(2,8)}`;\n  const jobDir = path.join(root, 'jobs', jobId);\n  await fsp.mkdir(jobDir, { recursive: true });\n\n  const now = new Date().toISOString();\n  const job = {\n    id: jobId,\n    type: body.type || 'audio',\n    status: 'pending',\n    params: body.params || {},\n    artifacts: [],\n    logs: [],\n    created_at: now,\n    updated_at: now,\n  };\n\n  const exists = async (p) => !!(await fsp.stat(p).catch(() => null));\n  if (!(await exists(queuePath))) {\n    await fsp.mkdir(path.dirname(queuePath), { recursive: true });\n    await fsp.writeFile(queuePath, JSON.stringify({ pending: [] }, null, 2));\n  }\n  if (!(await exists(statePath))) {\n    await fsp.writeFile(statePath, JSON.stringify({ processing: {}, version: 1 }, null, 2));\n  }\n\n  await fsp.writeFile(path.join(jobDir, 'job.json'), JSON.stringify(job, null, 2));\n\n  const queue = JSON.parse(await fsp.readFile(queuePath, 'utf8'));\n  queue.pending = queue.pending || [];\n  queue.pending.push({\n    id: jobId,\n    type: job.type,\n    priority: body.priority || 0,\n    submitted_at: now,\n    payload_path: path.relative(root, path.join(jobDir, 'job.json')),\n  });\n  await fsp.writeFile(queuePath, JSON.stringify(queue, null, 2));\n\n  return [{ json: { status: 'enqueued', job_id: jobId, queue_size: queue.pending.length } }];\n} catch (e) {\n  return [{ json: { status: 'error', error: e.message } }];\n}"
      },
      "name": "Code - Enqueue",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        200,
        300
      ]
    }
  ],
  "connections": {
    "Webhook - Add": {
      "main": [
        [
          {
            "node": "Code - Enqueue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "ai-music"
    }
  ]
}
