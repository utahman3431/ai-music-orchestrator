{
  "name": "Health Check - Queue Integrity",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "health/queue",
        "options": {
          "responseData": "={{$json}}"
        },
        "responseMode": "lastNode"
      },
      "name": "Webhook - Health Queue",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -200,
        300
      ],
      "webhookId": "health-queue"
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst fsp = fs.promises;\nconst path = require('path');\nconst root = '/data/orchestration';\nconst queuePath = path.join(root, 'queue.json');\nconst statePath = path.join(root, 'state.json');\n\nasync function safeReadJson(p) {\n  try {\n    return JSON.parse(await fsp.readFile(p, 'utf8'));\n  } catch (e) {\n    return { __error: e.message };\n  }\n}\n\nconst queue = await safeReadJson(queuePath);\nconst state = await safeReadJson(statePath);\n\nconst missingFiles = [];\nif (queue.__error) missingFiles.push({ file: queuePath, error: queue.__error });\nif (state.__error) missingFiles.push({ file: statePath, error: state.__error });\n\nconst pendingMissing = [];\nfor (const p of queue.__error ? [] : (queue.pending || [])) {\n  const jobPath = path.join(root, p.payload_path);\n  try { await fsp.access(jobPath); } catch { pendingMissing.push(p.id); }\n}\n\nconst orphaned = [];\nfor (const jobId of state.__error ? [] : Object.keys(state.processing || {})) {\n  const jobPath = path.join(root, 'jobs', jobId, 'job.json');\n  try { await fsp.access(jobPath); } catch { orphaned.push(jobId); }\n}\n\nconst ok = !missingFiles.length && !pendingMissing.length && !orphaned.length;\nreturn [{ json: { status: ok ? 'ok' : 'degraded', pending: queue.__error ? null : (queue.pending || []).length, processing: state.__error ? null : Object.keys(state.processing || {}).length, pendingMissing, orphaned, missingFiles } }];"
      },
      "name": "Code - Check Queue",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        200,
        300
      ]
    }
  ],
  "connections": {
    "Webhook - Health Queue": {
      "main": [
        [
          {
            "node": "Code - Check Queue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "ai-music"
    }
  ]
}
